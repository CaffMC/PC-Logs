<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Compact Build Logs</title>

    <meta name="description"
        content="Compact Build Logs helps track and manage PC build logs, efficiently calculating resale profits and costs for PC flipping projects." />
    <meta name="keywords"
        content="PC build logs, PC flipping, gaming PC builds, resale tracking, computer build records, budget PC build, profit calculation, PC Flipping tracker, PC flipping logs" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

</head>

<body>
    <nav class="navbar">
        <ul class="nav-list">
            <li><a href="home.html" class="nav-link">Home</a></li>
            <li><a href="index.html" class="nav-link">Add Build</a></li>
            <li><a href="compact-logs.html" class="nav-link">All Logs</a></li>
        </ul>
    </nav>

    <style>
        /* Same styles as before for layout, navbar, buttons, modal, forms, etc. */
        .navbar {
            background-color: #ff6f61;
            padding: 12px 24px;
        }

        .nav-list {
            list-style: none;
            display: flex;
            gap: 24px;
            margin: 0;
            padding: 0;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 700;
            font-size: 18px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 32px;
            color: #333;
        }

        #compactLogList {
            max-width: 600px;
            margin: 0 auto;
        }

        .compactLogEntry {
            background: white;
            padding: 10px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compactLogEntry:hover {
            background-color: #ffecea;
        }

        .logName {
            font-weight: 700;
            flex-grow: 1;
        }

        .logSummary {
            white-space: nowrap;
            flex-shrink: 0;
            margin-left: 20px;
        }

        #editLogBtn {
            position: absolute;
            bottom: 16px;
            right: 90px;
            /* horizontally left of Remove button */
            background: #ff6f61;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #editLogBtn:hover {
            background-color: #e55a56;
            /* Optional: slightly darker on hover */
        }


        #modal,
        #editModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fffaf0;
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(255, 111, 97, 0.35);
            position: relative;
        }

        .close {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 28px;
            font-weight: 700;
            color: #ff6f61;
            cursor: pointer;
            user-select: none;
        }

        #removeLogBtn {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: #ff6f61;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn {
            background-color: #ff6f61;
            color: white;
            font-weight: 700;
            padding: 12px 32px;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }

        .part-row {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
            align-items: center;
        }

        .part-input,
        .price-input {
            flex: 1;
            min-width: 0;
            padding: 12px 16px;
            font-size: 16px;
            font-weight: 500;
            border: 2px solid #ddd;
            border-radius: 12px;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .part-input:focus,
        .price-input:focus {
            border-color: #ff6f61;
            outline: none;
            box-shadow: 0 0 10px rgba(255, 111, 97, 0.6);
        }
    </style>


    <h2>All Build Logs (click to expand details)</h2>
    <div id="compactLogList"></div>

    <!-- Details Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">&times;</span>
            <h2>Build Log Details</h2>
            <pre id="modalDetails" style="white-space: pre-wrap; font-family: inherit;"></pre>
            <button id="removeLogBtn">Remove</button>
            <button id="editLogBtn" style="margin-left: 10px;">Edit</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span id="closeEditModal" class="close">&times;</span>
            <h2 id="editModalTitle">Edit Build Log</h2>
            <form id="editForm">
                <label>PC Name: <input type="text" name="name" /></label>

                <div class="part-row">
                    <input type="text" name="gpu" placeholder="GPU" class="part-input" />
                    <input type="number" min="0" step="0.01" name="gpuPrice" placeholder="Price" class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="cpu" placeholder="CPU" class="part-input" />
                    <input type="number" min="0" step="0.01" name="cpuPrice" placeholder="Price" class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="ram" placeholder="RAM" class="part-input" />
                    <input type="number" min="0" step="0.01" name="ramPrice" placeholder="Price" class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="motherboard" placeholder="Motherboard" class="part-input" />
                    <input type="number" min="0" step="0.01" name="motherboardPrice" placeholder="Price"
                        class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="psu" placeholder="PSU" class="part-input" />
                    <input type="number" min="0" step="0.01" name="psuPrice" placeholder="Price" class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="storage" placeholder="Storage" class="part-input" />
                    <input type="number" min="0" step="0.01" name="storagePrice" placeholder="Price"
                        class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="psuExt" placeholder="PSU Extensions" class="part-input" />
                    <input type="number" min="0" step="0.01" name="psuExtPrice" placeholder="Price"
                        class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="cpuCooler" placeholder="CPU Cooler" class="part-input" />
                    <input type="number" min="0" step="0.01" name="cpuCoolerPrice" placeholder="Price"
                        class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="fans" placeholder="Fans" class="part-input" />
                    <input type="number" min="0" step="0.01" name="fansPrice" placeholder="Price" class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="case" placeholder="Case" class="part-input" />
                    <input type="number" min="0" step="0.01" name="casePrice" placeholder="Price" class="price-input" />
                </div>

                <div class="part-row">
                    <input type="text" name="extras" placeholder="Extras" class="part-input" />
                    <input type="number" min="0" step="0.01" name="extrasPrice" placeholder="Price"
                        class="price-input" />
                </div>

                <label>Location Sold:
                    <select name="locationSold">
                        <option value="local">Local</option>
                        <option value="online">Online</option>
                    </select>
                </label>

                <label>Date Listed:
                    <input type="date" name="dateListed" />
                </label>

                <label>Date Sold:
                    <input type="date" name="dateSold" />
                </label>

                <label>Sale Price:
                    <input type="number" min="0" step="0.01" name="sale" />
                </label>

                <button type="submit" class="btn">Save</button>
            </form>
        </div>
    </div>

    <div id="overlay" class="overlay" style="display:none;"></div>

    <script type="module">
        import { auth, db } from './firebase-init.js';
        import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

        const compactLogList = document.getElementById('compactLogList');
        const modal = document.getElementById('modal');
        const modalDetails = document.getElementById('modalDetails');
        const closeModalBtn = document.getElementById('closeModal');
        const removeLogBtn = document.getElementById('removeLogBtn');
        const editLogBtn = document.getElementById('editLogBtn');
        const editModal = document.getElementById('editModal');
        const closeEditModalBtn = document.getElementById('closeEditModal');
        const editForm = document.getElementById('editForm');
        const overlay = document.getElementById('overlay');

        let logs = [];
        let currentLogIndex = null;

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function createDetailsHTML(log) {
            const partsHTML = Object.entries(log.parts).filter(([key, value]) => value && !key.toLowerCase().includes('price'))
                .map(([key, value]) => `${capitalize(key)}: ${value} ($${(log.parts[key + 'Price'] || 0).toFixed(2)})`)
                .join('\n');
            const locationSoldHtml = log.locationSold ? `\nLocation Sold: ${log.locationSold}` : '';
            const dateListedHtml = log.dateListed ? `\nDate Listed: ${log.dateListed}` : '';
            const dateSoldHtml = log.dateSold ? `\nDate Sold: ${log.dateSold}` : '';

            return `${log.name || 'Unnamed Build'}\n${partsHTML}${locationSoldHtml}${dateListedHtml}${dateSoldHtml}

Total Cost: $${log.totalCost.toFixed(2)}
Sale Price: $${log.sale.toFixed(2)}
Profit: $${log.profit.toFixed(2)}`;
        }

        function renderLogs() {
            compactLogList.innerHTML = '';
            if (logs.length === 0) {
                compactLogList.innerHTML = '<p>No builds logged yet.</p>';
                return;
            }
            logs.forEach((log, index) => {
                const entry = document.createElement('div');
                entry.classList.add('compactLogEntry');
                entry.innerHTML = `<span class="logName">${log.name || 'Unnamed Build'}</span>
                           <span class="logSummary">Cost: $${log.totalCost.toFixed(2)} | Sale: $${log.sale.toFixed(2)} | Profit: $${log.profit.toFixed(2)}</span>`;
                entry.onclick = () => openDetailsModal(log, index);
                compactLogList.appendChild(entry);
            });
        }

        async function loadLogsFromFirestore() {
            if (!auth.currentUser) {
                compactLogList.innerHTML = "<p>Please sign in to view your logs.</p>";
                return;
            }
            try {
                const q = query(collection(db, "buildLogs"), where("userId", "==", auth.currentUser.uid));
                const querySnapshot = await getDocs(q);
                logs = [];
                querySnapshot.forEach(doc => {
                    logs.push({ id: doc.id, ...doc.data() });
                });
                renderLogs();
            } catch (error) {
                compactLogList.innerHTML = `<p>Error loading logs: ${error.message}</p>`;
            }
        }

        function openDetailsModal(log, index) {
            currentLogIndex = index;
            modalDetails.textContent = createDetailsHTML(log);
            modal.style.display = 'flex';
            overlay.style.display = 'block';
        }

        closeModalBtn.onclick = () => {
            modal.style.display = 'none';
            overlay.style.display = 'none';
            modalDetails.textContent = '';
            currentLogIndex = null;
        };

        overlay.onclick = () => {
            modal.style.display = 'none';
            editModal.style.display = 'none';
            overlay.style.display = 'none';
            modalDetails.textContent = '';
            currentLogIndex = null;
        };

        removeLogBtn.onclick = async () => {
            if (currentLogIndex !== null) {
                try {
                    // Delete from Firestore
                    const docId = logs[currentLogIndex].id;
                    await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js")
                        .then(({ doc, deleteDoc }) => deleteDoc(doc(db, "buildLogs", docId)));
                    logs.splice(currentLogIndex, 1);
                    renderLogs();
                    closeModalBtn.onclick();
                } catch (error) {
                    alert('Failed to remove log: ' + error.message);
                }
            }
        };

        editLogBtn.onclick = () => {
            if (currentLogIndex !== null) {
                openEditModal(logs[currentLogIndex], currentLogIndex);
            }
        };

        function openEditModal(log, index) {
            editModal.style.display = 'flex';
            overlay.style.display = 'block';

            editForm.elements['name'].value = log.name || '';
            for (const key in log.parts) {
                if (editForm.elements[key]) editForm.elements[key].value = log.parts[key];
            }
            editForm.elements['locationSold'].value = log.locationSold || '';
            editForm.elements['dateListed'].value = log.dateListed || '';
            editForm.elements['dateSold'].value = log.dateSold || '';
            editForm.elements['sale'].value = log.sale || '';
            currentLogIndex = index;
        }

        closeEditModalBtn.onclick = () => {
            editModal.style.display = 'none';
            overlay.style.display = 'none';
            editForm.reset();
        };

        editForm.onsubmit = async function (e) {
            e.preventDefault();

            const formData = new FormData(editForm);
            const partsKeys = ['gpu', 'gpuPrice', 'cpu', 'cpuPrice', 'ram', 'ramPrice', 'motherboard', 'motherboardPrice',
                'psu', 'psuPrice', 'storage', 'storagePrice', 'psuExt', 'psuExtPrice', 'cpuCooler', 'cpuCoolerPrice',
                'fans', 'fansPrice', 'case', 'casePrice', 'extras', 'extrasPrice'];

            const parts = {};
            partsKeys.forEach(key => {
                if (key.toLowerCase().includes('price')) {
                    parts[key] = parseFloat(formData.get(key)) || 0;
                } else {
                    parts[key] = formData.get(key) || '';
                }
            });

            const name = formData.get('name') || '';
            const locationSold = formData.get('locationSold') || '';
            const dateListed = formData.get('dateListed') || '';
            const dateSold = formData.get('dateSold') || '';
            const sale = parseFloat(formData.get('sale')) || 0;

            const totalCost = Object.keys(parts).filter(k => k.toLowerCase().includes('price'))
                .reduce((acc, k) => acc + parts[k], 0);
            const profit = sale - totalCost;

            const updatedLog = { name, parts, totalCost, sale, profit, locationSold, dateListed, dateSold };

            if (currentLogIndex !== null) {
                try {
                    // Update Firestore document
                    const docId = logs[currentLogIndex].id;
                    await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js")
                        .then(({ doc, updateDoc }) => updateDoc(doc(db, "buildLogs", docId), updatedLog));

                    logs[currentLogIndex] = { ...logs[currentLogIndex], ...updatedLog };
                    renderLogs();
                    closeEditModalBtn.onclick();
                    closeModalBtn.onclick();
                } catch (error) {
                    alert('Failed to update log: ' + error.message);
                }
            }
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                loadLogsFromFirestore();
            } else {
                compactLogList.innerHTML = "<p>Please sign in to view your logs.</p>";
                logs = [];
            }
        });

        // Initial render while waiting for auth
        compactLogList.innerHTML = "<p>Loading logs...</p>";

    </script>

</body>

</html>